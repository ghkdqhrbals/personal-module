<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <title>Redis Stream Messages</title>
</head>
<body>
<h3>Redis Stream Messages</h3>

<div>
    <input id="rs_stream" placeholder="Stream (ex: summary:1)" style="width:260px;"/>
    <input id="rs_pageSize" type="number" value="5" min="1" style="width:70px;"/>
    <button onclick="RS.query()">Query</button>
</div>

<div style="margin-top:8px;">
    <input id="rs_cursorId" placeholder="Cursor ID (ex: 1735541234567-0)" style="width:260px;"/>
    <button onclick="RS.queryWithCursor()">Query from Cursor</button>
    <button onclick="RS.clearCursor()">Clear Cursor</button>
</div>

<div style="margin:12px 0;">
    <button onclick="RS.prev()" id="rs_prevBtn">Prev</button>
    <span id="rs_pageInfo"></span>
    <button onclick="RS.next()" id="rs_nextBtn">Next</button>
</div>

<table border="1" cellspacing="0" cellpadding="6" width="100%">
    <thead>
    <tr>
        <th>ID</th>
        <th>Timestamp</th>
        <th>Fields</th>
    </tr>
    </thead>
    <tbody id="rs_tbody"></tbody>
</table>

<script>
    (function () {
        const RS = {}; window.RS = RS;

        let curPage = 1;
        let curPageSize = 5;
        const pageCursor = { 1: null };

        RS.query = function () {
            curPage = 1;
            curPageSize = Number(document.getElementById("rs_pageSize").value);
            Object.keys(pageCursor).forEach(k => delete pageCursor[k]);
            pageCursor[1] = null;
            document.getElementById("rs_cursorId").value = '';
            load('reset');
        };

        RS.queryWithCursor = function () {
            const cursorId = document.getElementById("rs_cursorId").value.trim();
            if (!cursorId) return;
            curPage = 1;
            curPageSize = Number(document.getElementById("rs_pageSize").value);
            Object.keys(pageCursor).forEach(k => delete pageCursor[k]);
            pageCursor[1] = cursorId;
            load('reset');
        };

        RS.clearCursor = function () {
            document.getElementById("rs_cursorId").value = '';
            RS.query();
        };

        RS.next = function () {
            if (!pageCursor[curPage + 1]) return;
            curPage++;
            load('next');
        };

        RS.prev = function () {
            if (curPage <= 1) return;
            curPage--;
            load('prev');
        };

        async function load(mode) {
            const stream = document.getElementById("rs_stream").value.trim();
            if (!stream) return;

            const cursor = pageCursor[curPage] ?? null;
            const url = new URL(
                `http://localhost:7070/monitoring/streams/${encodeURIComponent(stream)}/messages`
            );
            if (cursor) url.searchParams.set("cursor", cursor);
            url.searchParams.set("pageSize", curPageSize);

            const res = await fetch(url);
            if (!res.ok) {
                render([]);
                setButtons(true, true, `HTTP ${res.status}`);
                return;
            }

            const data = await res.json();
            render(data.messages ?? []);

            if (mode !== 'prev' && data.hasMore && data.nextCursor) {
                pageCursor[curPage + 1] = data.nextCursor;
            }

            setButtons(
                curPage <= 1,
                !pageCursor[curPage + 1],
                `Page ${curPage} (Total ${data.totalCount ?? 0})`
            );
        }

        function setButtons(prevDisabled, nextDisabled, info) {
            document.getElementById("rs_prevBtn").disabled = prevDisabled;
            document.getElementById("rs_nextBtn").disabled = nextDisabled;
            document.getElementById("rs_pageInfo").textContent = info;
        }

        function render(messages) {
            const tbody = document.getElementById("rs_tbody");
            tbody.innerHTML = "";

            if (!messages || messages.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" align="center">No messages</td></tr>`;
                return;
            }

            messages.forEach(m => {
                const tr = document.createElement("tr");

                const idTd = document.createElement("td");
                idTd.innerHTML = `<a href="#" onclick="RS.copyCursor('${m.id}');return false;">${m.id}</a>`;

                const tsTd = document.createElement("td");
                tsTd.textContent = new Date(m.timestamp).toISOString();

                const fieldsTd = document.createElement("td");
                fieldsTd.innerHTML = `<pre>${JSON.stringify(m.fields, null, 2)}</pre>`;

                tr.appendChild(idTd);
                tr.appendChild(tsTd);
                tr.appendChild(fieldsTd);
                tbody.appendChild(tr);
            });
        }

        RS.copyCursor = function (id) {
            document.getElementById("rs_cursorId").value = id;
        };
    })();
</script>
</body>
</html>