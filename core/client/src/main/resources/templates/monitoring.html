<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <title>Redis Stream Messages</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 16px; }
        th, td { border: 1px solid #ccc; padding: 6px; vertical-align: top; }
        th { background: #f5f5f5; font-weight: 600; }
        pre { margin: 0; white-space: pre-wrap; }
        input[type="text"], input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 8px;
        }
        button {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 8px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .search-section {
            background: #f9f9f9;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
        .search-row { margin-bottom: 12px; }
        .pagination-controls { margin: 12px 0; display: flex; align-items: center; gap: 12px; }
        #rs_pageInfo { padding: 0 12px; font-weight: 500; }
        .hint { font-size: 12px; color: #666; margin-top: 4px; }
        .message-box {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 16px;
            display: none;
        }
        .message-box.show {
            display: block;
        }
        .message-box.info {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            color: #1976d2;
        }
        .message-box.warning {
            background: #fff3cd;
            border-left: 4px solid #ff9800;
            color: #856404;
        }
        .message-box.success {
            background: #d4edda;
            border-left: 4px solid #4CAF50;
            color: #155724;
        }
    </style>
</head>
<body>
<h3>ğŸ“Š Redis Stream Messages Viewer</h3>

<div id="rs_messageBox" class="message-box"></div>

<div class="search-section">
    <div class="search-row">
        <input id="rs_stream" placeholder="Stream ì´ë¦„ (ì˜ˆ: summary:1)" style="width: 300px;"/>
        <input id="rs_pageSize" type="number" value="5" min="1" max="100" style="width: 80px;" placeholder="í˜ì´ì§€ í¬ê¸°"/>
        <button onclick="RS.query()">ğŸ” ì²˜ìŒë¶€í„° ì¡°íšŒ</button>
    </div>
    <div class="search-row">
        <input id="rs_cursorId" placeholder="Cursor ID (ì˜ˆ: 1735541234567-0)" style="width: 300px;"/>
        <button onclick="RS.queryWithCursor()">â¡ï¸ Cursorë¶€í„° ì¡°íšŒ</button>
        <button onclick="RS.clearCursor()" style="background: #ff9800;">ğŸ—‘ï¸ Cursor ì´ˆê¸°í™”</button>
    </div>
    <div class="hint">
        ğŸ’¡ Tip: Cursor IDë¥¼ ì…ë ¥í•˜ë©´ í•´ë‹¹ ìœ„ì¹˜ë¶€í„° ì¡°íšŒë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ë¹„ì›Œë‘ë©´ ì²˜ìŒë¶€í„° ì¡°íšŒí•©ë‹ˆë‹¤.
    </div>
</div>

<div class="pagination-controls">
    <button onclick="RS.prev()" id="rs_prevBtn">â¬…ï¸ Prev</button>
    <span id="rs_pageInfo"></span>
    <button onclick="RS.next()" id="rs_nextBtn">Next â¡ï¸</button>
</div>

<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>Timestamp</th>
        <th>Fields</th>
    </tr>
    </thead>
    <tbody id="rs_tbody"></tbody>
</table>

<script>
    (function () {
        // ===== namespace ê³ ì • =====
        const RS = {};
        window.RS = RS;

        // ===== ìƒíƒœ (ì „ì—­ ì¶©ëŒ ë°©ì§€) =====
        let curPage = 1;
        let curPageSize = 5;
        let totalPages = 1;

        // pageë³„ ì‹œì‘ cursor (1í˜ì´ì§€ëŠ” null)
        const pageCursor = { 1: null };

        // ===== ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ =====
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('rs_messageBox');
            messageBox.textContent = message;
            messageBox.className = `message-box show ${type}`;

            // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€
            setTimeout(() => {
                messageBox.className = 'message-box';
            }, 3000);
        }

        // ===== API =====
        RS.query = function () {
            curPage = 1;
            curPageSize = Number(document.getElementById("rs_pageSize").value);
            Object.keys(pageCursor).forEach(k => delete pageCursor[k]);
            pageCursor[1] = null;
            document.getElementById("rs_cursorId").value = ''; // cursor ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            load('reset');
        };

        RS.queryWithCursor = function () {
            const cursorId = document.getElementById("rs_cursorId").value.trim();
            if (!cursorId) {
                showMessage('âš ï¸ Cursor IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            curPage = 1;
            curPageSize = Number(document.getElementById("rs_pageSize").value);
            Object.keys(pageCursor).forEach(k => delete pageCursor[k]);
            pageCursor[1] = cursorId;
            load('reset');
        };

        RS.clearCursor = function () {
            document.getElementById("rs_cursorId").value = '';
            showMessage('ğŸ—‘ï¸ Cursorê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            RS.query();
        };

        RS.next = function () {
            if (!pageCursor[curPage + 1]) return;
            curPage++;
            load('next');
        };

        RS.prev = function () {
            if (curPage <= 1) return;
            curPage--;
            load('prev');
        };

        async function load(mode) { // reset | next | prev
            const stream = document.getElementById("rs_stream").value.trim();
            if (!stream) {
                showMessage('âš ï¸ Stream ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            curPageSize = Number(document.getElementById("rs_pageSize").value);

            const cursor = pageCursor[curPage] ?? null;

            const url = new URL(
                `http://localhost:7070/monitoring/streams/messages/${encodeURIComponent(stream)}`
            );
            if (cursor) url.searchParams.set("cursor", cursor);
            url.searchParams.set("pageSize", curPageSize);

            console.log("REQUEST:", url.toString());
            console.log("Current Page:", curPage, "Cursor:", cursor);

            try {
                const res = await fetch(url);
                if (!res.ok) {
                    render([]);
                    setButtons(true, true, `HTTP ${res.status}: ${res.statusText}`);
                    showMessage(`âŒ ì˜¤ë¥˜: HTTP ${res.status} - ${res.statusText}`, 'warning');
                    return;
                }

                const data = await res.json();
                totalPages = Math.max(1, Math.ceil((data.totalCount ?? 0) / curPageSize));
                render(data.messages ?? []);

                // prev ë¡œë“œì—ì„œëŠ” ë‹¤ìŒ cursorë¥¼ ì ˆëŒ€ ë®ì–´ì“°ì§€ ì•ŠìŒ
                if (mode !== 'prev') {
                    if (data.hasMore && data.nextCursor) {
                        pageCursor[curPage + 1] = data.nextCursor;
                        console.log("Next cursor saved:", data.nextCursor);
                    }
                }

                setButtons(curPage <= 1, !pageCursor[curPage + 1], `Page ${curPage} / ${totalPages} (Total: ${data.totalCount ?? 0})`);


            } catch (error) {
                console.error('Fetch error:', error);
                render([]);
                setButtons(true, true, `Error: ${error.message}`);
                showMessage(`âŒ ìš”ì²­ ì‹¤íŒ¨: ${error.message}`, 'warning');
            }
        }

        function setButtons(prevDisabled, nextDisabled, info) {
            document.getElementById("rs_prevBtn").disabled = prevDisabled;
            document.getElementById("rs_nextBtn").disabled = nextDisabled;
            document.getElementById("rs_pageInfo").textContent = info;
        }

        function render(messages) {
            const tbody = document.getElementById("rs_tbody");
            tbody.innerHTML = "";

            if (!messages || messages.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #999;">ğŸ“­ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }

            messages.forEach(m => {
                const tr = document.createElement("tr");

                // IDë¥¼ í´ë¦­í•˜ë©´ cursor ì…ë ¥ í•„ë“œì— ë³µì‚¬
                const idCell = document.createElement("td");
                idCell.innerHTML = `<a href="#" onclick="RS.copyCursor('${m.id}'); return false;" style="color: #2196F3; text-decoration: none;">${m.id}</a>`;
                idCell.title = "í´ë¦­í•˜ì—¬ Cursor IDë¡œ ì„¤ì •";

                const timestampCell = document.createElement("td");
                const date = new Date(m.timestamp);
                timestampCell.innerHTML = `
                    ${date.toISOString()}<br>
                    <small style="color: #666;">${date.toLocaleString('ko-KR')}</small>
                `;

                const fieldsCell = document.createElement("td");
                fieldsCell.innerHTML = `<pre>${JSON.stringify(m.fields, null, 2)}</pre>`;

                tr.appendChild(idCell);
                tr.appendChild(timestampCell);
                tr.appendChild(fieldsCell);
                tbody.appendChild(tr);
            });
        }

        RS.copyCursor = function(id) {
            document.getElementById("rs_cursorId").value = id;
            showMessage(`âœ… Cursor IDê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤: ${id}`, 'success');
        };

        // ì—”í„°í‚¤ë¡œ ê²€ìƒ‰
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('rs_stream').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') RS.query();
            });
            document.getElementById('rs_cursorId').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') RS.queryWithCursor();
            });
        });
    })();
</script>
</body>
</html>